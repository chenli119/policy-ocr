# Vercel 部署错误解决方案

## 🚨 错误描述

**错误时间**: 2024年  
**错误环境**: Vercel 部署环境  
**错误类型**: 构建失败  

### 错误日志
```
Running "npm run build"
> vercel-cors-proxy@1.0.0 build
> vercel build
sh: line 1: vercel: command not found
Error: Command "npm run build" exited with 127
```

## 🔍 错误分析

### 根本原因
在 `package.json` 中的 `build` 脚本配置错误：
```json
{
  "scripts": {
    "build": "vercel build"  // ❌ 错误配置
  }
}
```

### 问题详解
1. **环境限制**: Vercel 构建环境中没有安装 `vercel` CLI 工具
2. **逻辑错误**: 在 Vercel 平台上部署时，不应该在构建脚本中调用 `vercel` 命令
3. **循环调用**: 这相当于在 Vercel 构建过程中再次调用 Vercel，造成逻辑混乱

## ✅ 解决方案

### 方案一：简化构建脚本（推荐）
对于无服务器函数项目，通常不需要复杂的构建步骤：

```json
{
  "scripts": {
    "dev": "vercel dev",
    "build": "echo 'No build step required for serverless functions'",
    "deploy": "vercel --prod"
  }
}
```

### 方案二：移除构建脚本
如果完全不需要构建步骤，可以直接移除：

```json
{
  "scripts": {
    "dev": "vercel dev",
    "deploy": "vercel --prod"
  }
}
```

### 方案三：自定义构建脚本
如果项目确实需要构建步骤（如 TypeScript 编译），可以设置：

```json
{
  "scripts": {
    "build": "tsc" // 或其他实际的构建命令
  }
}
```

## 🛠️ 修复步骤

1. **定位问题文件**
   - 文件路径: `package.json`
   - 问题行: `"build": "vercel build"`

2. **修改配置**
   ```bash
   # 将错误的构建脚本
   "build": "vercel build"
   
   # 修改为
   "build": "echo 'No build step required for serverless functions'"
   ```

3. **重新部署**
   ```bash
   git add .
   git commit -m "fix: 修复构建脚本配置错误"
   git push
   ```

## 📋 验证方法

### 本地验证
```bash
# 测试构建脚本
npm run build

# 应该输出: No build step required for serverless functions
```

### 部署验证
- 重新触发 Vercel 部署
- 检查构建日志是否正常
- 确认 API 端点可以正常访问

## 🔧 相关配置说明

### Node.js 版本警告
错误日志中还包含一个警告：
```
Warning: Detected "engines": { "node": ">=18.0.0" } in your `package.json`
```

**解释**: <mcreference link="http://vercel.link/node-version" index="0">0</mcreference>
- Vercel 会自动使用最新的 LTS Node.js 版本
- `>=18.0.0` 的配置会在新的主要版本发布时自动升级
- 这是一个警告，不会影响部署

**建议配置**:
```json
{
  "engines": {
    "node": "18.x"  // 固定主要版本
  }
}
```

## 🎯 最佳实践

### 1. Vercel 项目配置
- ✅ 使用简单的构建脚本或无构建脚本
- ✅ 避免在构建中调用 Vercel CLI
- ✅ 合理设置 Node.js 版本

### 2. 无服务器函数项目
- ✅ API 文件放在 `api/` 目录
- ✅ 使用 `export default` 导出处理函数
- ✅ 配置正确的 `vercel.json`

### 3. 部署流程
```bash
# 本地开发
vercel dev

# 预览部署
vercel

# 生产部署
vercel --prod
```

## 📚 相关文档

- [Vercel Node.js 版本支持](http://vercel.link/node-version)
- [Vercel 无服务器函数文档](https://vercel.com/docs/functions)
- [package.json 配置指南](https://docs.npmjs.com/cli/v7/configuring-npm/package-json)

## 🎉 解决结果

- ✅ **问题已解决**: 修复了 package.json 中的构建脚本配置
- ✅ **部署成功**: Vercel 可以正常构建和部署项目
- ✅ **功能正常**: API 端点可以正常提供跨域代理服务

---

**错误状态**: ✅ 已解决  
**解决时间**: 2024年  
**影响范围**: Vercel 部署流程  
**预防措施**: 遵循 Vercel 最佳实践，避免在构建脚本中调用平台命令